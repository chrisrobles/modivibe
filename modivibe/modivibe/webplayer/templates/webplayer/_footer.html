<fieldset class="playbar">
    <span class="playbarLeft">
        <img id="trackImage" src="" alt="Track Album Cover" width="64" height="64">
        <div class="trackInfoContainer">
            <p id="trackName">Track Name</p>
            <p id="trackArtist">Track Artist</p>
        </div>
    </span>
    <span class="playbarMiddle">
        <div class="trackControllers">
            <button id="shuffleTrackControl">SHFL: X</button>
            <button id="previousTrackControl" aria-label="Previous Track"><<</button>
            <button id="playbackControl">PLAY</button>
            <button id="nextTrackControl" aria-label="Next Track">>></button>
            <button id="repeatTrackControl">LOOP: X</button>
        </div>
    </span>
    <span class="playbarRight">
        <div class="volumeController">
            <label for="volumeControl">VOLUME:</label>
            <input type="number" id="volumeControl" placeholder="0-100" step="10" min="0" max="100" style="width: 75px" aria-label="Volume"></input>
        </div>
    </span>
</fieldset>

<script>
    let deviceID;
    let deviceState;
    let repeatStatus;
    let isPlaying = false;
    let isShuffled = false;


    window.onSpotifyWebPlaybackSDKReady = () => {
        const token = '{{ userAccessCode }}';
        const player = new Spotify.Player({
            name: 'Modivibe',
            getOAuthToken: cb => { cb(token); }
        });

        // Error handling
        player.addListener('initialization_error', ({message}) => { console.error(message); });
        player.addListener('authentication_error', ({message}) => { console.error(message); });
        player.addListener('account_error', ({message}) => { console.error(message); });
        player.addListener('playback_error', ({message}) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => {
            console.log(state);
            deviceState = state;

            // Update Track Name in Player
            $('#trackName').text(deviceState['track_window']['current_track']['name']);

            // Update Track Artists in Player
            let i;
            let artists = "";
            let artistsList = deviceState['track_window']['current_track']['artists'];
            for(i = 0; i < artistsList.length; i++){
                artists += artistsList[i]['name'];
                if (i != artistsList.length - 1) artists += ", ";
            }
            $('#trackArtist').text(artists)

            // Update Track Image in Player
            $('#trackImage').prop('src', deviceState['track_window']['current_track']['album']['images'][1]['url']);

            // Initially set Shuffle Status
            if ($('#shuffleTrackControl').text() === 'SHFL: X') {
                isShuffled = deviceState['shuffle'];
                let shuffleStatus = isShuffled ? 'Y' : 'N';
                $('#shuffleTrackControl').text('SHFL: ' + shuffleStatus);
            }

            // Initially set Repeat Status
            if ($('#repeatTrackControl').text() === 'LOOP: X') {
                repeatStatus = deviceState['repeat_mode'];
                let repeatValue;
                switch(repeatStatus) {
                    case 0: repeatValue = 'track'; break;
                    case 1: repeatValue = 'context'; break;
                    case 2: repeatValue = 'off'; break;
                    default: break;
                }
                $('#repeatTrackControl').text('LOOP: ' + repeatValue);
            }
        });

        // Ready
        player.addListener('ready', ({device_id}) => {
            console.log('Ready with Device ID', device_id);
            deviceID = device_id;
            // Trigger playback transfer to Modivibe
            console.log('Attempting to transfer playback');
            $.ajax({
                type: "POST",
                url: "{% url 'transferPlayback' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    device_id: deviceID,
                },
                success: function(response) {
                    if (response == 'True') {
                        console.log('Successfully transferred playback');
                    } else {
                        console.log('Failed to resume playback');
                    }
                }
            });
        });

        // Not Ready
        player.addListener('not_ready', ({device_id}) => {
            console.log('Device ID has gone offline', device_id);
        });

        // Connect to the player!
        player.connect();
    }

    $('#playbackControl').on('click', togglePlayback);
    $('#volumeControl').on('change', setVolume);
    $('#previousTrackControl').on('click', previousTrack);
    $('#nextTrackControl').on('click', nextTrack);
    $('#shuffleTrackControl').on('click', toggleShuffle);
    $('#repeatTrackControl').on('click', toggleRepeat);



    function togglePlayback(event){
        if (!isPlaying) {
            console.log('Requesting playback resume');
            $.ajax({
                type: "POST",
                url: "{% url 'setPlayback' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    device_id: deviceID,
                    status: 'play'
                },
                success: function(response) {
                    if (response == 'True') {
                        console.log('Successfully resuming playback');
                        $('#playbackControl').text('PAUSE');
                        isPlaying = true;
                    } else {
                        console.log('Failed to resume playback');
                    }
                }
            });

        } else {
            console.log('Requesting playback pause');
            $.ajax({
                type: "POST",
                url: "{% url 'setPlayback' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    device_id: deviceID,
                    status: 'pause'
                },
                success: function(response) {
                    if (response == 'True') {
                        console.log('Successfully pausing playback');
                        $('#playbackControl').text('PLAY');
                        isPlaying = false;
                    } else {
                        console.log('Failed to pause playback');
                    }
                }
            });
        }
    }

    function setVolume(event) {
       console.log('Attempting to set volume');
       $.ajax({
            type: "POST",
            url: "{% url 'setVolume' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                device_id: deviceID,
                volume: $(this).val()
            },
            success: function(response) {
                if (response == 'True') {
                    console.log('Successfully set volume');
                } else {
                    console.log('Failed to set volume');
                }
            }
        });
    }

    function previousTrack(event) {
        console.log('Attempting to play previous track');
        $.ajax({
            type: "POST",
            url: "{% url 'previousTrack' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                device_id: deviceID,
            },
            success: function(response) {
                if (response == 'True') {
                    console.log('Successfully played previous track');
                } else {
                    console.log('Failed to play previous track');
                }
            }
        });
    }

    function nextTrack(event) {
        console.log('Attempting to play next track');
        $.ajax({
            type: "POST",
            url: "{% url 'nextTrack' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                device_id: deviceID,
            },
            success: function(response) {
                if (response == 'True') {
                    console.log('Successfully played next track');
                } else {
                    console.log('Failed to play next track');
                }
            }
        });
    }

    function toggleShuffle(event){
        if (!isShuffled) {
            console.log('Attempting to enable shuffle');
            $.ajax({
                type: "POST",
                url: "{% url 'setShuffle' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    device_id: deviceID,
                    shuffle_status: 'enabled'
                },
                success: function(response) {
                    if (response == 'True') {
                        console.log('Successfully enabled shuffle');
                        isShuffled = true;
                        $('#shuffleTrackControl').text('SHFL: Y');
                    } else {
                        console.log('Failed to enable shuffle');
                    }
                }
            });

        } else {
            console.log('Attempting to disable shuffle');
            $.ajax({
                type: "POST",
                url: "{% url 'setShuffle' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    device_id: deviceID,
                    shuffle_status: 'disabled'
                },
                success: function(response) {
                    if (response == 'True') {
                        console.log('Successfully disabled shuffle');
                        isShuffled = false;
                        $('#shuffleTrackControl').text('SHFL: N');
                    } else {
                        console.log('Failed to disable shuffle');
                    }
                }
            });
        }
    }

    function toggleRepeat(event) {
        console.log('Attempting to toggle repeat state');
        repeatStatus += 1;
        if (repeatStatus > 2 || repeatStatus < 0) repeatStatus = 0;
        $.ajax({
                type: "POST",
                url: "{% url 'setRepeat' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    device_id: deviceID,
                    repeat_status: repeatStatus
                },
                success: function(response) {
                    if (response != 'False') {
                        console.log('Successfully toggled repeat state');
                        $('#repeatTrackControl').text('LOOP: ' + response);
                    } else {
                        console.log('Failed to toggle repeat state');
                        repeatStatus -= 1;
                    }
                }
        });
    }

</script>
